
!###################################################
! WARNING:This is a test auto-generated by KROME, in order to
! show a bare-minimal code to call the KROME's subroutine.
! Most of the values could not be appropriate for your
! problem, since this test is only intended as a general
! purpose example.

program test
  ! include 'mpif.h'
  use krome_main !use krome (mandatory)
  use krome_user !use utility (for krome_idx_* constants and others)
  implicit none
  integer,parameter::nsp=krome_nmols !number of species (common)
  integer,parameter::numTimes=32
  integer::i,j,isys,spec
  real*8::Tgas(4096),dt,x(nsp),spy,t,nH,Av,CRrate,times(numTimes)
  real*8::coef(krome_nrea)
  real*8,parameter :: pi=3.14159265
  real*8,parameter :: rD=1.0d-5
  real*8,parameter :: rhoD=3.0
  real*8,parameter :: DtoGM=7.09d-3
  real*8,parameter :: amH=1.66043d-24
  real*8 :: GtoDN
  real*8 :: OPRH2 = 0.1
  real*8 :: COdep
  real*8 :: Ndep
  real*8 :: starttime, endtime
  real*8 :: rawdata(4096, 133), abund(4096, 131)
  integer :: clock_rate, clock_start, clock_stop

  real*8 :: mass(nsp) = (/ &
      1d0, 1200d0, 1d0, 2d0, 12d0, 16d0, 26d0, 17d0, 18d0, 2d0, 2d0, &
      3d0, 4d0, 4d0, 1d0, 2d0, 1200d0, 4d0, 28d0, 12d0, 14d0, &
      16d0, 28d0, 15d0, 16d0, 30d0, 32d0, 17d0, 18d0, 25d0, 24d0, &
      26d0, 38d0, 26d0, 36d0, 40d0, 14d0, 16d0, 15d0, 44d0, 18d0, &
      20d0, 19d0, 27d0, 28d0, 29d0, 30d0, 27d0, 28d0, 31d0, 32d0, &
      44d0, 16d0, 18d0, 17d0, 46d0, 33d0, 34d0, 42d0, 13d0, 14d0, &
      3d0, 3d0, 4d0, 4d0, 5d0, 5d0, 6d0, 6d0, 1d0, 3d0, &
      4d0, 4d0, 4d0, 29d0, 30d0, 12d0, 2d0, 14d0, 16d0, 2d0, &
      2d0, 13d0, 14d0, 30d0, 32d0, 14d0, 16d0, 15d0, 31d0, 32d0, &
      16d0, 18d0, 17d0, 28d0, 24d0, 17d0, 18d0, 25d0, 26d0, 15d0, &
      16d0, 18d0, 20d0, 19d0, 26d0, 36d0, 40d0, 29d0, 30d0, 38d0, &
      38d0, 27d0, 28d0, 27d0, 28d0, 42d0, 29d0, 30d0, 33d0, 34d0, &
      5d0, 6d0, 28d0, 44d0, 46d0, 6d0, 19d0, 20d0, 21d0, 22d0 &
      /)




  open( unit=10, file="timeres.dat", status="OLD", action="READ")
  do i=1, numTimes
    read (10, *) times(i)
  enddo
  open( unit=11, file="evolution.dat")
  ! open( unit=12, file="dfrac.dat")
  open( unit=13, file="Kout.dat")
  open( unit=14, file="input.dat")
  open( unit=15, file="time.txt")
  open( unit=20, file="cellabund.dat", status="OLD", action="READ")

  do i = 1, 4096
    read(20, *) (rawdata(i, j), j = 1, 133)
    abund(i, :) = rawdata(i, 3:133)
    Tgas(i) = rawdata(i, 2)
  end do

  read(14, *) 
  read(14, *) Av
  read(14, *) 
  read(14, *) CRrate
  read(14, *) 
  read(14, *) Ndep
  read(14, *)
  read(14, *) COdep
  
  close(14)
  spy = 3.65d2 * 2.4d1 * 3.6d3 !seconds per year

  call krome_init() !init krome (mandatory)

  t = 0d0

  GtoDN = (4.d0*pi*rhoD*rD*rD*rD)/(3.d0*DtoGM*amH)
  call krome_set_user_Av(Av)
  call krome_set_user_crflux(CRrate)
  call krome_set_user_GtoDN(GtoDN)
  print *,"Av,CR,GtoDn=",Av,CRrate,GtoDN

  !call the solver
  ! call krome(x(:), Tgas, dt) !call KROME
  ! coef = krome_get_coef(Tgas, x)
  do i=1, krome_nrea
    write(13, *) i, coef(i)
  enddo

  !mass(:) = krome_get_mass()

  do i=1, numTimes-1
     do isys = 1, 4096
       write(11,'(133E17.8e3)') isys, t/31536000.0, abund(isys, :)
     enddo

     dt = (times(i+1)-times(i)) * spy
     t = t + dt !increase time

     ! starttime = MPI_Wtime()
     call system_clock(count_rate=clock_rate)
     call system_clock(count=clock_start)
     do isys = 1, 4096
       call krome(abund(isys, :), Tgas(isys), dt) !call KROME
     enddo
     ! endtime = MPI_Wtime()
     call system_clock(count=clock_stop) 
     write(15,'(E12.5)') real(clock_stop-clock_start)/real(clock_rate)
     print *, "t = ",t/31536000.0," yr, ", "elapsed = ", real(clock_stop-clock_start)/real(clock_rate), " sec"
  end do

  do isys = 1, 4096
    write(11,'(133E17.8e3)') isys, t/31536000.0, abund(isys, :)
  enddo



  close(10)
  close(11)
  ! close(12)
  close(13)
  close(15)
  print *,"Test OK!"

end program test

